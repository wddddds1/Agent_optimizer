directions:
  - id: parallel_omp
    description: "OpenMP parallel strategy (threads + affinity + backend enable)."
    applies_to: ["run_config"]
    expected_effect: ["compute_opt", "mem_locality"]
    risk_level: "low"
    preconditions: []
    constraints: []
    verification_plan:
      gates: ["runtime", "correctness", "variance"]
      thresholds:
        variance_cv_max: 0.05
    templates:
      - id: close_cores
        description: "OMP={threads}, bind close, places cores, enable OpenMP backend."
        env:
          OMP_NUM_THREADS: "{threads}"
          OMP_PROC_BIND: "close"
          OMP_PLACES: "cores"
          OMP_DYNAMIC: "false"
        backend_enable: "openmp"
      - id: spread_cores
        description: "OMP={threads}, bind spread, places cores, enable OpenMP backend."
        env:
          OMP_NUM_THREADS: "{threads}"
          OMP_PROC_BIND: "spread"
          OMP_PLACES: "cores"
          OMP_DYNAMIC: "false"
        backend_enable: "openmp"

  - id: affinity_tune
    description: "Affinity tuning without changing thread count."
    applies_to: ["run_config"]
    expected_effect: ["mem_locality", "imbalance_reduce"]
    risk_level: "low"
    preconditions: []
    constraints: []
    verification_plan:
      gates: ["runtime", "variance"]
      thresholds:
        variance_cv_max: 0.03
    presets:
      - id: bind_close
        description: "Set OMP_PROC_BIND=close and OMP_PLACES=cores."
        env:
          OMP_PROC_BIND: "close"
          OMP_PLACES: "cores"
      - id: bind_spread
        description: "Set OMP_PROC_BIND=spread and OMP_PLACES=cores."
        env:
          OMP_PROC_BIND: "spread"
          OMP_PLACES: "cores"

  - id: wait_policy
    description: "OpenMP wait policy tuning."
    applies_to: ["run_config"]
    expected_effect: ["mem_locality", "imbalance_reduce"]
    risk_level: "low"
    preconditions: []
    constraints: []
    verification_plan:
      gates: ["runtime", "variance"]
      thresholds:
        variance_cv_max: 0.03
    presets:
      - id: wait_active
        description: "Set OMP_WAIT_POLICY=active."
        env:
          OMP_WAIT_POLICY: "active"
      - id: wait_passive
        description: "Set OMP_WAIT_POLICY=passive."
        env:
          OMP_WAIT_POLICY: "passive"

  - id: sched_granularity
    description: "OpenMP schedule/granularity tuning."
    applies_to: ["run_config"]
    expected_effect: ["imbalance_reduce"]
    risk_level: "low"
    preconditions: []
    constraints: []
    verification_plan:
      gates: ["runtime", "variance"]
      thresholds:
        variance_cv_max: 0.03
    presets:
      - id: schedule_static
        description: "Set OMP_SCHEDULE=static."
        env:
          OMP_SCHEDULE: "static"
      - id: schedule_dynamic
        description: "Set OMP_SCHEDULE=dynamic"
        env:
          OMP_SCHEDULE: "dynamic"

  - id: runtime_lib
    description: "Runtime library/allocator tuning."
    applies_to: ["run_config"]
    expected_effect: ["compute_opt"]
    risk_level: "medium"
    preconditions: ["case_tag:allow_runtime_lib"]
    constraints: []
    verification_plan:
      gates: ["runtime", "correctness", "variance"]
      thresholds:
        variance_cv_max: 0.05
    presets:
      - id: disable_nanov2
        description: "Disable macOS nano allocator for large allocations."
        env:
          MallocNanoZone: "0"
